# WhatsApp Interactive Button Setup - Complete Guide

## ğŸ¯ What This Does

When a cashier creates a credit request:
1. Admin receives WhatsApp message with **2 buttons**: âœ… Approve | âŒ Reject
2. Admin clicks button directly in WhatsApp
3. System **automatically approves/rejects** the credit
4. Admin receives confirmation message
5. **No manual API calls needed!**

---

## ğŸ“‹ Prerequisites

### 1. WhatsApp Business API Account
You need:
- **Meta Business Account**
- **WhatsApp Business API** (not regular WhatsApp Business app)
- **Phone Number ID**
- **Access Token**
- **Webhook URL** (your server's public URL)

**Get Started:** https://developers.facebook.com/docs/whatsapp/cloud-api/get-started

---

## ğŸ”§ Setup Steps

### Step 1: Update Database

```sql
-- Add phone_number to tbl_users table
ALTER TABLE tbl_users 
ADD COLUMN phone_number VARCHAR(15) DEFAULT NULL AFTER email,
ADD UNIQUE INDEX idx_phone_number (phone_number);

-- Update admin user with phone number
UPDATE tbl_users 
SET phone_number = '9876543210' 
WHERE role = 'admin' AND email = 'admin@example.com';
```

### Step 2: Environment Variables

Update your `.env` file:

```bash
# WhatsApp Business API Configuration
WHATSAPP_API_URL=https://graph.facebook.com/v18.0
WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id
WHATSAPP_ACCESS_TOKEN=your_permanent_access_token
ADMIN_WHATSAPP_PHONE=919876543210

# Webhook Configuration
WHATSAPP_WEBHOOK_URL=https://your-domain.com/api/whatsapp/webhook
WHATSAPP_VERIFY_TOKEN=your_random_secret_token_123
```

**Important:**
- `WHATSAPP_PHONE_NUMBER_ID`: Get from Meta Business Manager
- `WHATSAPP_ACCESS_TOKEN`: Generate permanent token from Meta
- `ADMIN_WHATSAPP_PHONE`: Must match phone in database (with country code)
- `WHATSAPP_VERIFY_TOKEN`: Any random string (for webhook verification)

### Step 3: Configure WhatsApp Webhook

1. Go to your **Meta App Dashboard**
2. Navigate to **WhatsApp > Configuration**
3. Set **Webhook URL**: `https://your-domain.com/api/whatsapp/webhook`
4. Set **Verify Token**: Same as `WHATSAPP_VERIFY_TOKEN` in .env
5. Subscribe to **messages** field
6. Click **Verify and Save**

### Step 4: Register Routes in Your App

In your `app.js` or `server.js`:

```javascript
const whatsappRoutes = require('./routes/whatsapp.routes');

// Add this route
app.use('/api/whatsapp', whatsappRoutes);
```

### Step 5: Make Server Publicly Accessible

For WhatsApp to send webhooks, your server must be:
- **Publicly accessible** (not localhost)
- **HTTPS enabled** (SSL certificate required)

Options:
- Deploy to cloud (AWS, DigitalOcean, Heroku)
- Use ngrok for testing: `ngrok http 5000`

---

## ğŸ”„ Complete Flow Example

### 1. Cashier Creates Credit Request

**API Call:**
```bash
POST http://localhost:5000/api/credit/request
Authorization: Bearer cashier_token

{
  "player_name": "Amit Sharma",
  "phone_number": "9123456789",
  "requested_amount": 700000,
  "chips_amount": 700000
}
```

**Response:**
```json
{
  "success": true,
  "message": "Credit request sent for admin approval",
  "data": {
    "request_id": 4,
    "status": "pending"
  }
}
```

### 2. Admin Receives WhatsApp Message

```
ğŸ”” New Credit Request

ğŸ“‹ Request ID: #4
ğŸ‘¤ Player: Amit Sharma
ğŸ’° Amount: â‚¹7,00,000.00
ğŸ“Š Available Float: â‚¹5,00,000.00
ğŸ“… Date: 2024-12-13

âš ï¸ WARNING: Request exceeds available float!

[âœ… Approve]  [âŒ Reject]
```

### 3. Admin Clicks Button

Admin clicks **âœ… Approve** in WhatsApp

### 4. System Processes Automatically

Behind the scenes:
1. WhatsApp sends webhook to your server
2. Server identifies button click: `approve_4`
3. System calls `approveCreditRequest(4, adminId)`
4. Credit is issued to player
5. Database updated
6. Audit log created

### 5. Admin Receives Confirmation

```
âœ… Credit Approved

Request #4 has been approved.
Player: Amit Sharma
Amount: â‚¹7,00,000.00

Credit has been issued to the player.
```

---

## ğŸ§ª Testing

### Test 1: Verify Webhook Setup

```bash
curl "https://your-domain.com/api/whatsapp/webhook?hub.mode=subscribe&hub.verify_token=your_random_secret_token_123&hub.challenge=test123"
```

**Expected Response:** `test123`

### Test 2: Simulate Button Click (Without WhatsApp)

```bash
POST http://localhost:5000/api/whatsapp/test-button
Authorization: Bearer admin_token
Content-Type: application/json

{
  "request_id": 4,
  "action": "approve"
}
```

This simulates what happens when admin clicks the button.

### Test 3: Full Integration Test

1. Create credit request as cashier
2. Check WhatsApp - you should receive message with buttons
3. Click âœ… Approve or âŒ Reject
4. Check database: `SELECT * FROM tbl_credit_requests WHERE request_id = 4;`
5. Status should be updated to 'approved' or 'rejected'

---

## ğŸ“± WhatsApp Message Examples

### Credit Request (With Buttons)
```
ğŸ”” New Credit Request

ğŸ“‹ Request ID: #5
ğŸ‘¤ Player: Rajesh Kumar
ğŸ’° Amount: â‚¹3,00,000.00
ğŸ“Š Available Float: â‚¹5,00,000.00
ğŸ“… Date: 2024-12-13

âœ… Float is sufficient

[âœ… Approve]  [âŒ Reject]
```

### Approval Confirmation
```
âœ… Credit Approved

Request #5 has been approved.
Player: Rajesh Kumar
Amount: â‚¹3,00,000.00

Credit has been issued to the player.
```

### Rejection Confirmation
```
âŒ Credit Rejected

Request #5 has been rejected.
Player: Rajesh Kumar
Amount: â‚¹3,00,000.00

Rejected by admin via WhatsApp
```

### Error Message (If Something Fails)
```
âŒ Approval Failed

Request #5
Error: Credit request already approved
```

---

## ğŸ” Security Considerations

### 1. Verify Webhook Source

The webhook controller should verify that requests come from WhatsApp:

```javascript
// Add to whatsapp.controller.js
verifyWebhookSignature(req) {
  const signature = req.headers['x-hub-signature-256'];
  const payload = JSON.stringify(req.body);
  
  const expectedSignature = crypto
    .createHmac('sha256', process.env.WHATSAPP_APP_SECRET)
    .update(payload)
    .digest('hex');
  
  return signature === `sha256=${expectedSignature}`;
}
```

### 2. Phone Number Verification

Only admin with registered phone number can approve:
```javascript
// Already implemented in getAdminByPhone()
const admin = await db.select(
  'tbl_users',
  'user_id, username, full_name, role, phone_number',
  'phone_number = ? AND role = ? AND is_active = 1',
  [cleanPhone, 'admin']
);
```

### 3. Request Status Check

System automatically checks if request is still pending before approval.

---

## ğŸ› Troubleshooting

### Issue 1: Not Receiving WhatsApp Messages

**Check:**
- âœ… `WHATSAPP_ACCESS_TOKEN` is valid (not expired)
- âœ… `WHATSAPP_PHONE_NUMBER_ID` is correct
- âœ… `ADMIN_WHATSAPP_PHONE` has country code (919876543210)
- âœ… Admin phone is verified in Meta Business Manager

**Test:**
```bash
curl -X POST "https://graph.facebook.com/v18.0/YOUR_PHONE_NUMBER_ID/messages" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messaging_product": "whatsapp",
    "to": "919876543210",
    "type": "text",
    "text": {
      "body": "Test message"
    }
  }'
```

### Issue 2: Webhook Not Working

**Check:**
- âœ… Server is publicly accessible (use ngrok for testing)
- âœ… Webhook URL is HTTPS (required by WhatsApp)
- âœ… Webhook is verified in Meta dashboard
- âœ… `WHATSAPP_VERIFY_TOKEN` matches in both .env and Meta

**View Logs:**
```bash
# Check webhook calls
tail -f logs/app.log
```

### Issue 3: Button Click Not Processing

**Check:**
- âœ… Admin phone number matches database
- âœ… Admin role is 'admin' in database
- âœ… Request ID is valid and status is 'pending'

**Debug:**
```javascript
// Add logging in whatsapp.controller.js
console.log('Message received:', JSON.stringify(message, null, 2));
console.log('Button ID:', buttonId);
console.log('Admin user:', adminUser);
```

### Issue 4: "Insufficient Float" Error

**Solution:** This error has been removed! Admin now receives a WARNING in the WhatsApp message but can still approve even if float is insufficient. The admin makes the final decision.

---

## ğŸ“Š Database Tracking

### Check Credit Request Status
```sql
SELECT 
  cr.request_id,
  cr.player_name,
  cr.requested_amount,
  cr.request_status,
  cr.whatsapp_sent,
  cr.created_at,
  cr.processed_at,
  u.full_name as approved_by_name
FROM tbl_credit_requests cr
LEFT JOIN tbl_users u ON cr.approved_by = u.user_id
ORDER BY cr.created_at DESC
LIMIT 10;
```

### Check WhatsApp Notifications
```sql
SELECT 
  notification_id,
  notification_type,
  reference_id,
  status,
  sent_at,
  created_at
FROM tbl_whatsapp_notifications
ORDER BY created_at DESC
LIMIT 20;
```

### Check Audit Logs
```sql
SELECT 
  audit_id,
  user_id,
  action,
  table_name,
  record_id,
  new_data,
  ip_address,
  created_at
FROM tbl_audit_logs
WHERE action LIKE '%CREDIT_REQUEST%'
ORDER BY created_at DESC
LIMIT 20;
```

---

## ğŸ¨ Customization

### Change Button Text

In `whatsapp.service.js`:
```javascript
buttons: [
  {
    type: "reply",
    reply: {
      id: `approve_${data.request_id}`,
      title: "à¤¹à¤¾à¤, à¤¸à¥à¤µà¥€à¤•à¤¾à¤° à¤•à¤°à¥‡à¤‚" // Hindi
    }
  },
  {
    type: "reply",
    reply: {
      id: `reject_${data.request_id}`,
      title: "à¤¨à¤¹à¥€à¤‚, à¤…à¤¸à¥à¤µà¥€à¤•à¤¾à¤°" // Hindi
    }
  }
]
```

### Add More Information

```javascript
const message = `ğŸ”” New Credit Request

ğŸ“‹ Request ID: #${data.request_id}
ğŸ‘¤ Player: ${data.player_name}
ğŸ“± Phone: ${data.player_phone}
ğŸ’° Amount: â‚¹${this.formatAmount(data.requested_amount)}
ğŸ’³ Current Credit: â‚¹${this.formatAmount(data.current_outstanding)}
ğŸ“Š Available Float: â‚¹${this.formatAmount(data.available_float)}
ğŸ“… Date: ${data.session_date}
â° Time: ${new Date().toLocaleTimeString('en-IN')}

${data.requested_amount > data.available_float ? 'âš ï¸ *WARNING: Request exceeds available float!*' : 'âœ… Float is sufficient'}`;
```

---

## ğŸš€ Production Deployment Checklist

- [ ] Server deployed with HTTPS
- [ ] Environment variables configured
- [ ] Database migrated with phone_number field
- [ ] Admin phone number added to database
- [ ] WhatsApp webhook configured in Meta
- [ ] Webhook verified and receiving messages
- [ ] Test credit request flow end-to-end
- [ ] Monitor logs for errors
- [ ] Set up alerts for failed notifications
- [ ] Document for your team

---

## ğŸ“ Support & Resources

- **WhatsApp Business API Docs:** https://developers.facebook.com/docs/whatsapp
- **Interactive Messages:** https://developers.facebook.com/docs/whatsapp/guides/interactive-messages
- **Webhook Setup:** https://developers.facebook.com/docs/graph-api/webhooks

---

## ğŸ’¡ Pro Tips

1. **Use Template Messages** for faster approval (pre-approved by WhatsApp)
2. **Add logging** to track every webhook call
3. **Set up monitoring** to alert if webhooks fail
4. **Test with ngrok** before production deployment
5. **Keep access tokens secure** (never commit to git)

---

## âœ… Success Criteria

You know it's working when:
- âœ… Cashier creates credit request â†’ Admin receives WhatsApp immediately
- âœ… Admin clicks button â†’ System updates within seconds
- âœ… Admin receives confirmation message
- âœ… Database shows updated status
- âœ… No manual API calls needed!